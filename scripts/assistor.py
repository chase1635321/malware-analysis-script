#!/usr/bin/python3

import r2pipe
import os
import base64
from termcolor import colored

# Build function manual analyzer that traverses up the function call tree, picking the function closest to the bottom that has the highest percent renamed functions or library calls
# pdfs sometimes misses function calls, do pdf~call instead
# Add radare2 command to recursivley rename functions to ignore

os.system("clear")

r = r2pipe.open()

r.cmd("e prj.simple = true")

projectname = ""
imports = []
strings = []

def main():
    initialize()
    print_info()
    import_identifier()
    string_identifier()
    function_renamer()
    initialize_notes()
    function_iterate()

def function_iterate():
    i = 1
    for f in r.cmdj("aflj"):
        os.system("clear")
        print(str(i) + "/" + str(len(r.cmd("afl").split("\n"))) + " ", end="")
        r.cmd("s " + hex(f["offset"]))
        print(f["signature"])
        print(r.cmd("pdfs~call"))
        cmd = input()
        if not cmd == "":
            r.cmd("afn " + cmd + "[" + f["name"].split("[")[1])

def initialize_notes():
    global projectname
    title = "# " + projectname + " Analysis" + "\n"
    title = base64.b64encode(title.encode())
    r.cmd("Pnj " + title.decode())
    r.cmd("Pn+" + "## Executive Summary")
    r.cmd("Pn+" + "### Installation")
    r.cmd("Pn+" + "How malware gets installed goes here")
    r.cmd("Pn+" + "")
    r.cmd("Pn+" + "### Behavior")
    r.cmd("Pn+" + "What the malware does goes here")
    r.cmd("Pn+" + "")
    r.cmd("Pn+" + "### Persistence")
    r.cmd("Pn+" + "How the malware persists on the system goes here")
    r.cmd("Pn+" + "")
    r.cmd("Pn+" + "### Removal")
    r.cmd("Pn+" + "How the malware can be uninstalled goes here")
    r.cmd("Pn+" + "")
    r.cmd("Pn+" + "## Analysis")
    r.cmd("Pn+" + "Add detailed analysis here. Add code with !radare2 command")
    r.cmd("Pn+" + "")
    print(r.cmd("Pn"))

def function_renamer():
    for f in r.cmdj("aflj"):
        name = f["name"]
        r.cmd("s " + name)
        name += "["

        code = r.cmd("pdfs")
        size = f["size"]

        xrefs = len(r.cmdj("axtj"))
        calls = len(r.cmd("pdfs~call").split("\n"))
        
        name += str(calls) + "," + str(xrefs) + ","

        if not "call" in code:
            name += "leaf" + ","
        if size < 20:
            name += "small" + ","
        if size > 300:
            name += "large" + ","

        name = name.strip(",")
        name += "]"

        r.cmd("afn " + name)

def string_identifier():
    global strings
    strings_json = r.cmdj("izj")

    i = 0
    j = len(strings_json)
    print(str(j))
    
    while i < j:
        os.system("clear")

        for k in range(i, i+20):
            try:
                print(str(k) + "\t" + strings_json[k]["string"])
            except:
                break

        while True:
            print("Input string index: ", end="")
            index = input()
            if index == "":
                break
            else:
                r.cmd("s " + hex(strings_json[int(index)]["vaddr"]))
                r.cmd("CCu report: string")
                xrefs_json = r.cmdj("axtj")
                xrefs = []

                for xref in xrefs_json:
                    try:
                        xrefs.append((xref["from"], xref["fcn_name"]))
                    except:
                        xrefs.append((xref["from"], hex(xref["from"])))

                strings.append((hex(strings_json[int(index)]["vaddr"]), strings_json[int(index)]["string"], xrefs))
        i += 20

def import_identifier():
    global imports
    imports_json = r.cmdj("iij")
    print(r.cmd("ii"))
    
    val = "blabla"
    while val != "":
        print("Input relevant imports: ", end="")
        val = input()

        if val == "":
            continue

        found = False
        for i in imports_json:
            if i["name"].strip() == val.strip():
                found = True
                addr = hex(i["plt"])
        if found:
            imports.append((addr, val))
            r.cmd("s " + addr)
            r.cmd("CCu report: import")
        else:
            print(colored("Import name not found", "red"))


    
def print_info():
    print(colored("Malware info: ", "yellow"))
    print("   " + r.cmd("i~format").strip())
    print("   " + r.cmd("i~arch").strip())
    print("   " + r.cmd("i~bits").strip())
    print("   " + r.cmd("i~nx").strip())
    print("   " + r.cmd("i~os").strip())
    print("   " + r.cmd("i~static").strip())
    print("   " + r.cmd("i~stripped").strip())

def initialize():
    global projectname
    print("Enter project name: ", end = "") 
    projectname = input()

    if projectname == "":
        projectname = r.cmdj("ij")["core"]["file"]

    r.cmd("Pd " + projectname)

    print(colored("Analyzing file", "yellow"))
    r.cmd("aaa")

    print(colored("\nSaving project as " + projectname, "yellow"))
    r.cmd("Ps " + projectname)

main()
